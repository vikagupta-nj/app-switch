<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Bridge • App Switch (Sim)</title>
<style>
  :root { color-scheme: light dark; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding:20px; }
  .card { margin:auto; max-width:520px; border:1px solid #ddd; border-radius:16px; padding:18px; }
  h1 { margin:0 0 8px; font-size:22px; }
  p  { margin:8px 0; line-height:1.4; }
  button { margin-top:12px; width:100%; padding:12px 14px; border:0; border-radius:12px; font-size:16px; }
  .primary { background:#0070ba; color:#fff; }
  .hint { opacity:.7; font-size:14px; }
</style>

<div class="card">
  <h1>Bridge</h1>
  <p class="hint">This tab (T2) stays open while the PayPal app handles approval. When you return, we’ll resume.</p>
  <p id="status">Waiting…</p>
  <button id="openApp" class="primary" hidden>Open in PayPal app</button>
</div>

<script>
  // Keep T2 from auto "back" snap
  history.replaceState(null, "", location.href);
  history.pushState(null, "", location.href);
  addEventListener("popstate", () => history.pushState(null, "", location.href));

  const q = new URLSearchParams(location.search);
  const token   = q.get("token")   || "EC-EXAMPLE";
  const sdkMeta = q.get("sdkMeta") || "ENCODED_SDK_META";
  const appLink = `https://paypal.com/app-switch-checkout?token=${encodeURIComponent(token)}&sdkMeta=${encodeURIComponent(sdkMeta)}`;

  const isAndroidChrome = /Android/i.test(navigator.userAgent) &&
                          /Chrome\/\d+/i.test(navigator.userAgent) &&
                          !/SamsungBrowser/i.test(navigator.userAgent);

  // If user returns to T2, resume (stub: you’d poll token & route to merchant)
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      document.getElementById("status").textContent = "Bridge focused — checking status…";
      // TODO: fetch('/status?token=...') then redirect to merchant return/cancel URL
    }
  });

  // Show a manual “Open in PayPal app” button in case app didn’t open
  setTimeout(() => {
    const btn = document.getElementById("openApp");
    btn.hidden = false;
    btn.onclick = () => {
      if (isAndroidChrome) {
        const T3 = window.open("", "_blank");          // must be in a user gesture
        if (T3) {
          try { T3.location = appLink; } catch(e) {}
          setTimeout(() => { try { T3.close(); } catch(e){} }, 1800);
        } else {
          location.href = appLink;                     // last resort
        }
      } else {
        location.href = appLink;                       // iOS/etc.
      }
    };
  }, 1400);
</script>
</html>
