<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Bridge • App Switch</title>
<style>
  :root { color-scheme: light dark; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  main { min-height: 100svh; display:grid; place-items:center; padding:24px; }
  a.btn {
    display:block; text-align:center; text-decoration:none;
    padding:16px 20px; border-radius:14px; font-size:18px;
    background:#0070ba; color:#fff; width:100%; max-width:420px;
    -webkit-tap-highlight-color: transparent;
  }
  p { max-width:520px; opacity:.75; line-height:1.4; text-align:center; margin-top:12px; }
</style>

<main>
  <div>
    <!-- The anchor itself performs the user-gesture navigation to intent:// -->
    <a id="openApp" class="btn" href="#">Continue in PayPal app</a>
    <p>If this doesn’t open the app, you likely don’t have the PayPal app (or supported links) enabled.</p>
  </div>
</main>

<script>
  // Build the HTTPS app link (non-www). Use whichever token you have.
  const q = new URLSearchParams(location.search);
  const token   = q.get("token");          // e.g. EC-...
  const baToken = q.get("ba_token");       // e.g. BA-...
  const sdkMeta = q.get("sdkMeta") || "ENCODED_SDK_META";

  const base = "https://paypal.com/app-switch-checkout";
  const qp   = new URLSearchParams();
  if (baToken) qp.set("ba_token", baToken);
  if (token)   qp.set("token",    token);
  qp.set("sdkMeta", sdkMeta);
  const redirectUrl = `${base}?${qp.toString()}`;

  // Your exact intent builder
  function getIntentUrl(redirectUrl) {
    const encodedRedirect = redirectUrl.replace(/^https?:\/\//, '');
    const encodedFallback = encodeURIComponent(redirectUrl);
    return `intent://${encodedRedirect}#Intent;scheme=https;package=com.paypal.android.p2pmobile;S.browser_fallback_url=${encodedFallback};end;`;
  }

  // Keep this bridge tab committed in history (helps survival after app switch)
  history.replaceState(null, "", location.href);
  history.pushState(null, "", location.href);
  addEventListener("popstate", () => history.pushState(null, "", location.href));

  // Wire the anchor to the intent URL so the TAP triggers the navigation
  const a = document.getElementById("openApp");
  const intentUrl = getIntentUrl(redirectUrl);
  a.setAttribute("href", intentUrl);

  // Optional: also try to open on Enter/Space for accessibility
  a.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      // Let the default click nav happen
    }
  });
</script>
</html>
